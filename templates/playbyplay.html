<div class="mt-4">
    <h3 class="text-center">Play-by-Play</h3>
    <div id="play-by-play" class="p-2 border rounded" style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
        <!-- Play-by-play entries will be dynamically inserted here -->
    </div>
</div>

<script>
    function formatGameClock(timeStr) {
        const match = timeStr.match(/PT(\d+)M([\d.]+)S/);
        if (match) {
            const minutes = match[1].padStart(2, '0');
            const seconds = Math.floor(parseFloat(match[2])).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }
        return "00:00";  // Default if format is incorrect
    }

    function updatePlayByPlay(gameId) {
        fetch(`/get_play_by_play/${gameId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const container = document.getElementById('play-by-play');
                container.innerHTML = '';  // Clear previous entries

                data.plays.slice().forEach(play => {
                    const playElement = document.createElement('div');
                    playElement.className = 'd-flex justify-content-between align-items-center border-bottom py-2';

                    let imgElement;
                    if (play.personId) {
                        imgElement = document.createElement('img');
                        imgElement.src = `https://cdn.nba.com/headshots/nba/latest/1040x760/${play.personId}.png`;
                        imgElement.alt = "Player";
                        imgElement.className = "img-fluid me-2";
                        imgElement.style.maxHeight = "50px";
                        imgElement.onerror = () => { 
                            imgElement.src = "https://via.placeholder.com/50"; 
                        };  // Fallback image 
                    } else {
                        imgElement = document.createElement('img');
                        imgElement.src = `https://cdn.nba.com/logos/nba/${play.teamId}/primary/L/logo.svg`;
                        imgElement.alt = "Team";
                        imgElement.className = "img-fluid me-2";
                        imgElement.style.maxHeight = "50px";
                    }

                    const playText = document.createElement('div');
                    playText.textContent = play.description;
                    playText.className = "flex-grow-1";

                    const timeText = document.createElement('div');
                    const period = play.period ? `Period ${play.period}` : "N/A";
                    const clock = play.clock ? formatGameClock(play.clock) : "00:00";
                    timeText.textContent = `${period}, ${clock}`;
                    timeText.className = "text-muted small";

                    playElement.appendChild(imgElement);
                    playElement.appendChild(playText);
                    playElement.appendChild(timeText);
                    
                    container.prepend(playElement);
                });
            })
            .catch(error => console.error('Error fetching play-by-play:', error));
    }

    document.addEventListener('DOMContentLoaded', function () {
        const gameId = "{{ gameDetails['gameId'] }}";

        updatePlayByPlay(gameId);

        setInterval(() => updatePlayByPlay(gameId), 5000);
    });
</script>
